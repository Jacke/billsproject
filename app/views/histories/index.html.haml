# encoding: utf-8
%section.header.history-main
  %h1 –ò—Å—Ç–æ—Ä–∏—è
  .control-content
    %span.history –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–ª–æ–∫, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏ –æ –µ–≥–æ —Ç–∏–ø–µ.
  %ul.pager.history-option
    %li
      = link_to '–ú–µ—Å—è—Ü', histories_path(sort: 'by_month')
    %li
      = link_to '–ù–µ–¥–µ–ª—è', histories_path(sort: 'by_week')
    / /%li
    / /  = link_to '–î–∞—Ç–∞', histories_path(sort: 'by_month')
  / /pager
  %ul
    %span –¢–æ—á–∫–∏
  - @sites.each do |site|
    %li
      = link_to site.name, histories_path(sort: 'by_site', site: site.id)
      = link_to 'All', histories_path
%table.table.histories
  %tr
    %th –¢–æ—á–∫–∞
    %th –°–æ—Ç—Ä—É–¥–Ω–∏–∫
    %th –ë–∞–ª–∞–Ω—Å
    %th –ö–∞—Å—Å–∞
    %th –°–¥–∞–Ω–æ / –ü—Ä–∏–Ω—è—Ç–æ
    // Count of headers
    - count = @shifts.joins("LEFT OUTER JOIN shift_row_assigns on shifts.id=shift_row_assigns.shift_id").group("shifts.id").count("shift_row_assigns.id").max[1]
    - count.times do |th|
      %th
    %th
    %th 
  - @shifts.each do |shift|
    %tr.first
      %td= shift.site.name if shift.site.present?
      %td= shift.employee.first_name if shift.employee.present?
      %td= shift.balance 
      %td= shift.till
      %td= shift.accept_at
      - diffs = []
      - shift.shift_row_assigns.each do |as|
        - if as.shift_row.present? && as.shift_row.row_type == 6
          %td#popoverData
            %a{"data-content" => "#{as.shift_row.title}", "data-original-title" => "–ö–æ–ª–æ–Ω–∫–∞", "data-placement" => "bottom", "data-trigger" => "hover", :href => "#", :rel => "popover"}= as.def
            - diffs << as.def 
        - else
          %td
      %td
      %td
    %tr
      %td
      %td
      %td= @hoar.select {|n| n.shift_id == shift.id }[0].balance if @hoar.select {|n| n.shift_id == shift.id }[0].present?
      %td= @hoar.select {|n| n.shift_id == shift.id }[0].till  if @hoar.select {|n| n.shift_id == shift.id }[0].present?
      %td= shift.cancel_at
      - exp_rows = ShiftRow.where('row_type != 6 AND row_type != 1 AND site_id IS NULL').collect {|r| [r.id,  "#{r.title}", r.row_type ] }
      - row_vls = ShiftRowAssign.where(shift_id: shift.id).to_a.each_with_object({}){ |c,h| h[c.shift_row_id] = c.def }
      
      - # collect shift_row ids by specific row_type
      - (2..5).each do |row_type|
        - if row_vls.present?
          - z = exp_rows.select { |num| num[2] == row_type } # {59=>"–ò–Ω–∫–∞—Å—Å–∞—Ü–∏ 60=>"–ü—Ä–æ—Ü–µ–Ω—}
          - Hash[z.map {|n,z| [n, z]}].each do |row_id, row_name| 
            %td#popoverData
              %a{"data-content" => "#{row_name}", "data-original-title" => "‚ñí^‚ñí–æ–ª–æ–Ω–∫–∞", "data-placement" => "bottom", "data-trigger" => "hover", :href => "#", :rel => "popover"}= row_vls[row_id]
        - else
          %td#popoverData
            %a{"data-content" => "#{row_type}", "data-original-title" => "‚ñí^‚ñí^‚ñí^‚ñí^‚ñí^‚ñí–æ–ª–æ–Ω–∫–∞", "data-placement" => "bottom", "data-trigger" => "hover", :href => "#", :rel => "popover"} 0
      
      - shift.shift_row_assigns.each do |as|
        - if as.shift_row.present? && as.shift_row.row_type == 1
          %td#popoverData
            %a{"data-content" => "#{as.shift_row.title}", "data-original-title" => "–ö–æ–ª–æ–Ω–∫–∞", "data-placement" => "bottom", "data-trigger" => "hover", :href => "#", :rel => "popover"}= as.def
            - diffs << as.def if as.shift_row.row_type == 6 || as.shift_row.row_type == 1
        / /- else
        / /  %td
      %td
      %td 
    %tr.last
      %td 
        %b –ò—Ç–æ–≥–æ
      %td
      %td
        - if shift.balance.present? && @hoar.select {|n| n.shift_id == shift.id }[0].present? 
          = @hoar.select {|n| n.shift_id == shift.id }[0].balance - shift.balance 
      %td
  
      %td
      - shift.shift_row_assigns.each do |as|
        - if as.shift_row.present? && as.shift_row.row_type == 6 #|| as.shift_row.row_type == 1
          %td= diffs.inject(:-).to_i
      %td
      %td
      %td
      %td
      %td
      %td
      %td 
        = link_to '', edit_history_path(shift), class: 'fui-new'
        = link_to '', shift, :method => :delete, :data => { :confirm => 'Are you sure?' }, class: 'fui-cross'
%br
%h3 Total
%table.table.histories
  %tr
    %th –¢–æ—á–∫–∞
    %th –°–æ—Ç—Ä—É–¥–Ω–∏–∫
    %th –ë–∞–ª–∞–Ω—Å
    %th –ö–∞—Å—Å–∞
    %th –°–¥–∞–Ω–æ / –ü—Ä–∏–Ω—è—Ç–æ
    // Count of headers
    - count.times do |th|
      %th
    %th
    %th %table.table.histories
  %tr
    %td Total
:javascript
  $('#popoverData a').popover();
  $('#popoverOption').popover({ trigger: "hover" });
